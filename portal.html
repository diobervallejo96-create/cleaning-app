<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reservar servicio de limpieza</title>
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="icon-192.png" />
    <meta name="theme-color" content="#3b82f6" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #f5f7fa;
      }
      header {
        background: #3b82f6;
        color: #ffffff;
        padding: 1rem 2rem;
        text-align: center;
      }
      main {
        margin: 0 auto;
        max-width: 600px;
        padding: 2rem;
      }
      section {
        margin-bottom: 2rem;
        padding: 1rem;
        background: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      h2 {
        margin-top: 0;
      }
      label {
        display: block;
        margin-top: 0.5rem;
      }
      input,
      select {
        width: 100%;
        padding: 0.5rem;
        margin-top: 0.25rem;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      button {
        margin-top: 1rem;
        padding: 0.5rem 1rem;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #2563eb;
      }
      #portalResult p {
        margin: 0.5rem 0;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Reserva tu servicio de limpieza</h1>
    </header>
    <main>
      <section>
        <h2>Reservar servicio</h2>
        <!-- Información del proveedor (se mostrará cuando se acceda con parámetro provider) -->
        <div id="portalProviderInfo" class="hidden" style="display:flex; align-items:center; gap:1rem; margin-bottom: 1rem;"></div>
        <label for="portalName">Nombre:</label>
        <input type="text" id="portalName" />
        <label for="portalService">Servicio:</label>
        <select id="portalService"></select>
        <label for="portalDate">Fecha:</label>
        <input type="date" id="portalDate" />
        <label for="portalTime">Hora:</label>
        <input type="time" id="portalTime" />
        <label for="portalPrice">¿Cuánto estás dispuesto a pagar? ($):</label>
        <input type="number" id="portalPrice" min="1" step="0.01" />
        <label>Detalles de la casa:</label>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem;">
          <div>
            <label for="portalRooms">Habitaciones:</label>
            <input type="number" id="portalRooms" min="0" value="0" />
          </div>
          <div>
            <label for="portalBathrooms">Baños:</label>
            <input type="number" id="portalBathrooms" min="0" value="0" />
          </div>
          <div>
            <label for="portalLiving">Salas de estar:</label>
            <input type="number" id="portalLiving" min="0" value="0" />
          </div>
          <div>
            <label for="portalKitchens">Cocinas:</label>
            <input type="number" id="portalKitchens" min="0" value="0" />
          </div>
        </div>
        <label for="portalOther">Otros detalles (opcional):</label>
        <textarea id="portalOther" rows="2"></textarea>
        <label for="portalReferral">Código de referido (opcional):</label>
        <input type="text" id="portalReferral" />
        <button id="portalBookBtn">Reservar</button>
        <div id="portalResult"></div>
      </section>
    </main>
    <!-- Reutilizamos la lógica compartida -->
    <script src="script.js"></script>
    <script>
      window.onload = function () {
        // Asegurar que el administrador exista para inicializar la estructura
        ensureAdmin();
        // Poblar servicios en el formulario
        const select = document.getElementById('portalService');
        services.forEach(function (service) {
          const option = document.createElement('option');
          option.value = service.id;
          // Mostrar solo el nombre del servicio sin precio en el desplegable
          option.textContent = service.name;
          select.appendChild(option);
        });
        // Analizar parámetros de la URL para provider y ref
        const params = new URLSearchParams(window.location.search);
        const providerParam = params.get('provider');
        const refParam = params.get('ref');
        let selectedProvider = null;
        // Mostrar info del proveedor si corresponde
        if (providerParam) {
          const providerUser = getUsers().find(function (u) {
            return u.username === providerParam && u.role === 'cleaner';
          });
          if (providerUser) {
            selectedProvider = providerUser.username;
            const infoDiv = document.getElementById('portalProviderInfo');
            if (infoDiv) {
              infoDiv.classList.remove('hidden');
              infoDiv.innerHTML = '';
              const img = document.createElement('img');
              // Priorizar la imagen cargada (photoData) y luego la URL, si existe
              img.src = providerUser.photoData
                ? providerUser.photoData
                : providerUser.photoURL
                ? providerUser.photoURL
                : 'icon-192.png';
              img.alt = 'Proveedor';
              img.style.width = '70px';
              img.style.height = '70px';
              img.style.objectFit = 'cover';
              img.style.borderRadius = '50%';
              const detailsDiv = document.createElement('div');
              const nameP = document.createElement('p');
              nameP.textContent = providerUser.companyName && providerUser.companyName.length > 0 ? providerUser.companyName : providerUser.username;
              nameP.style.fontWeight = 'bold';
              detailsDiv.appendChild(nameP);
              if (providerUser.about) {
                const aboutP = document.createElement('p');
                aboutP.textContent = providerUser.about;
                detailsDiv.appendChild(aboutP);
              }
              if (providerUser.phone) {
                const phoneP = document.createElement('p');
                phoneP.textContent = 'Teléfono: ' + providerUser.phone;
                detailsDiv.appendChild(phoneP);
              }
              infoDiv.appendChild(img);
              infoDiv.appendChild(detailsDiv);
            }
          }
        }
        // Si hay parámetro de referido en la URL, prellenar y ocultar campo
        if (refParam) {
          const refInput = document.getElementById('portalReferral');
          if (refInput) {
            refInput.value = refParam;
            refInput.style.display = 'none';
            const refLabel = document.querySelector('label[for="portalReferral"]');
            if (refLabel) refLabel.style.display = 'none';
          }
        }
        // Manejar reserva desde portal
        document.getElementById('portalBookBtn').onclick = function () {
          const name = document.getElementById('portalName').value.trim();
          const serviceId = parseInt(document.getElementById('portalService').value, 10);
          const date = document.getElementById('portalDate').value;
          const time = document.getElementById('portalTime').value;
          const priceOffered = parseFloat(document.getElementById('portalPrice').value || '0');
          const rooms = parseInt(document.getElementById('portalRooms').value || '0');
          const bathrooms = parseInt(document.getElementById('portalBathrooms').value || '0');
          const living = parseInt(document.getElementById('portalLiving').value || '0');
          const kitchens = parseInt(document.getElementById('portalKitchens').value || '0');
          const other = (document.getElementById('portalOther').value || '').trim();
          // Si refParam existe, usarlo; de lo contrario usar valor del campo
          let referralCode = '';
          if (refParam) {
            referralCode = refParam;
          } else {
            referralCode = document.getElementById('portalReferral').value.trim();
          }
          if (!name || !date || !time) {
            alert('Por favor completa todos los campos requeridos');
            return;
          }
          // Obtener o crear usuario
          let users = getUsers();
          let user = users.find(function (u) {
            return u.username === name;
          });
          if (!user) {
            user = {
              username: name,
              password: '',
              role: 'customer',
              referralCode: name,
              discountCredits: 0,
            };
            users.push(user);
            setUsers(users);
          }
          // Calcular precio base del servicio y aplicar descuento si tiene créditos
          let finalPrice = 0;
          let discountApplied = 0;
          const serviceObj = services.find(function (s) {
            return s.id === serviceId;
          });
          if (serviceObj) finalPrice = serviceObj.price;
          // Aplicar cupón de descuento (30%) si el usuario tiene créditos
          const userIndex = users.findIndex(function (u) {
            return u.username === name;
          });
          if (userIndex >= 0) {
            const credits = users[userIndex].discountCredits || 0;
            if (credits > 0) {
              discountApplied = 0.3;
              finalPrice = finalPrice - finalPrice * discountApplied;
              users[userIndex].discountCredits = credits - 1;
              setUsers(users);
            }
          }
          // Procesar código de referido ingresado
          let referralUsed = null;
          if (referralCode && referralCode !== user.referralCode) {
            const allUsers = getUsers();
            const refIndex = allUsers.findIndex(function (u) {
              return u.referralCode === referralCode;
            });
            if (refIndex >= 0) {
              allUsers[refIndex].discountCredits = (allUsers[refIndex].discountCredits || 0) + 1;
              referralUsed = referralCode;
              setUsers(allUsers);
              alert('El usuario con código ' + referralCode + ' ha ganado un cupón de 30% de descuento para su próxima cita.');
            }
          }
          // Asignar proveedor: usar el parámetro si está definido, en caso contrario al de menos reservas
          const bookings = getBookings();
          let assigned = null;
          if (selectedProvider) {
            assigned = selectedProvider;
          } else {
            const providers = getUsers().filter(function (u) {
              return u.role === 'cleaner';
            });
            if (providers.length > 0) {
              const bookingsByProvider = {};
              providers.forEach(function (p) {
                bookingsByProvider[p.username] = bookings.filter(function (b) {
                  return b.cleaner === p.username;
                }).length;
              });
              assigned = providers.reduce(function (prev, curr) {
                return bookingsByProvider[curr.username] < bookingsByProvider[prev.username]
                  ? curr
                  : prev;
              }, providers[0]).username;
            }
          }
          const id = bookings.length > 0 ? Math.max.apply(null, bookings.map(function (b) { return b.id; })) + 1 : 1;
          bookings.push({
            id: id,
            serviceId: serviceId,
            customer: name,
            cleaner: assigned,
            date: date,
            time: time,
            status: 'pendiente',
            paymentStatus: 'pendiente',
            price: finalPrice,
            discountApplied: discountApplied,
            referralUsed: referralUsed,
            customerPrice: isNaN(priceOffered) ? null : priceOffered,
            houseDetails: {
              rooms: rooms,
              bathrooms: bathrooms,
              livingRooms: living,
              kitchens: kitchens,
              other: other,
            },
            providerOffer: null,
          });
          setBookings(bookings);
          // Mostrar resultado: no se muestra el precio base para no confundir al cliente.
          const resultDiv = document.getElementById('portalResult');
          resultDiv.innerHTML =
            '<p>¡Reserva creada con éxito!</p>' +
            '<p>Tu código de referido es: ' + user.referralCode + '.</p>';
          // Limpiar campos de entrada que no son persistentes
          if (!refParam) {
            document.getElementById('portalReferral').value = '';
          }
        };
      };
    </script>
  </body>
</html>